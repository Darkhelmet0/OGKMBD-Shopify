{{ 'video-banner-section.css' | asset_url | stylesheet_tag }}
{{ 'flickity.css' | asset_url | stylesheet_tag }}
{{ 'flickity.pkgd.min.js' | asset_url | script_tag }}

<div class="video-banner">
  {% if section.settings.enable_carousel %}
    <div class="video-banner__carousel banner-carousel {% if section.settings.enable_overlay %}overlay-enabled{% endif %}" data-flickity='{ "cellAlign": "left", "contain": true, "prevNextButtons": false, "pageDots": true, "autoPlay": true, "wrapAround": true }'>
      {% for block in section.blocks %}
        {% if block.type == 'slide_image' %}
          <div class="carousel-cell">
            {%- if block.settings.image != blank -%}
              {{ block.settings.image | image_url: width: 2000 | image_tag: 
                loading: 'lazy',
                class: 'video-banner__image',
                sizes: '100vw'
              }}
            {%- endif -%}
            <div class="video-banner__content page-width">
              <div class="content-container">
                  <h1 class='txt-wht'>{{ block.settings.heading }}</h1>
                  <p class="subtitle txt-wht">{{ block.settings.subheading }}</p>
                  {% if block.settings.link_url != blank %}
                    <a href="{{ block.settings.link_url }}" class="button button--seccondary btn-wht">{{ block.settings.link_title }}</a>
                  {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <div class="video-banner__video">
      <video autoplay loop muted playsinline poster="{{ section.settings.placeholder_image | image_url }}">
        <source src="{{ section.settings.video_url }}" type="video/mp4">
      </video>
    </div>
  {% endif %}

  {% unless section.settings.enable_carousel %}
    <div class="video-banner__content page-width">
      <div class="max-width-700">
        <h1 class='txt-wht'>{{ section.settings.heading }}</h1>
        <p class="subtitle txt-wht">{{ section.settings.subheading }}</p>
        {% if section.settings.link_url != blank %}
          <a href="{{ section.settings.link_url }}" class="button button--seccondary btn-wht">{{ section.settings.link_title }}</a>
        {% endif %}
      </div>
    </div>
  {% endunless %}
</div>


{% schema %}
{
  "name": "Video/Image Banner",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_carousel",
      "label": "Enable Image Carousel",
      "default": false,
      "info": "Switch between video and image carousel"
    },
    {
      "type": "checkbox",
      "id": "enable_overlay",
      "label": "Enable Overlay",
      "default": false,
      "info": "Add overlay effect to carousel slides"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Your Heading"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Your subheading goes here"
    },
    {
      "type": "url",
      "id": "video_url",
      "label": "Video URL",
      "info": "Paste the URL of your video (MP4 format recommended)"
    },
    {
      "type": "image_picker",
      "id": "placeholder_image",
      "label": "Video Placeholder Image",
      "info": "Choose an image to display as a placeholder for the video"
    },
    {
      "type": "url",
      "id": "link_url",
      "label": "Link URL"
    },
    {
      "type": "text",
      "id": "link_title",
      "label": "Link Title",
      "default": "Learn More"
    }
  ],
  "blocks": [
    {
      "type": "slide_image",
      "name": "Slide Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading", 
          "default": "Slide Heading"
        },
        {
          "type": "textarea",
          "id": "subheading",
          "label": "Subheading",
          "default": "Slide subheading text"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Button Link"
        },
        {
          "type": "text",
          "id": "link_title",
          "label": "Button Text",
          "default": "Learn More"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Video/Image Banner",
      "category": "Media"
    }
  ]
}
{% endschema %}

{% javascript %}
class BannerCarousel {
  constructor() {
    this.carousels = document.querySelectorAll('.banner-carousel');
    this.init();
  }

  init() {
    if (!this.carousels.length) return;
    
    this.carousels.forEach(carousel => {
      if (carousel.classList.contains('flickity-enabled')) return;

      const flkty = new Flickity(carousel, {
        cellAlign: 'left',
        contain: true,
        prevNextButtons: false,
        pageDots: true,
        autoPlay: 5000,
        wrapAround: true,
        fade: true,
        adaptiveHeight: false,
        draggable: true,
        selectedAttraction: 0.2,
        friction: 0.8,
        accessibility: true,
        ariaLabel: 'Banner Carousel'
      });

      // Pause autoplay on hover
      carousel.addEventListener('mouseenter', () => {
        flkty.pausePlayer();
      });

      carousel.addEventListener('mouseleave', () => {
        flkty.unpausePlayer();
      });

      // Handle visibility changes
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          flkty.pausePlayer();
        } else {
          flkty.unpausePlayer();
        }
      });
    });
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  new BannerCarousel();
});

// Re-initialize on Shopify section load
document.addEventListener('shopify:section:load', (event) => {
  if (event.target.querySelector('.banner-carousel')) {
    new BannerCarousel();
  }
});

// Handle Shopify section select
document.addEventListener('shopify:section:select', (event) => {
  const carousel = event.target.querySelector('.banner-carousel');
  if (carousel && carousel.classList.contains('flickity-enabled')) {
    const flkty = Flickity.data(carousel);
    flkty.resize();
  }
});
{% endjavascript %}
